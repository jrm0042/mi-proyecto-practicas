name: CI/CD Pipeline Automático

permissions:
  contents: write   # Necesario para crear tags automáticamente

on:
  push:
    branches:
      - main
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  tag-and-docker:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Traer todo el código y el historial completo
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2️⃣ Crear tag automático usando la acción oficial
      - name: Create Git tag automatically
        id: tag
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      # 3️⃣ Demo: imprimir la hora 3 veces
      - name: Print current time (demo)
        run: |
          for i in {1..3}; do date; sleep 60; done

      # 4️⃣ Build Docker
      - name: Build Docker image
        run: |
          docker build -t mi-app-flask:latest .
          docker images

      # 5️⃣ Log in Docker Hub
      - name: Docker Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 6️⃣ Debug: verificar tag generado y lista de imágenes
      - name: Debug Docker Tag & Images
        run: |
          echo "Tag generado automáticamente: ${{ steps.tag.outputs.new_tag }}"
          docker images

      # 7️⃣ Tag Docker image con fallback seguro y sin bloquear el workflow
      - name: Tag Docker image
        continue-on-error: true   # ⚡ ignorar errores aquí
        run: |
          TAG=${{ steps.tag.outputs.new_tag }}
          if [ -z "$TAG" ]; then
            echo "No se generó tag automático, uso 'v0.0.1' como fallback"
            TAG="v0.0.1"
          fi
          docker tag mi-app-flask:latest ${{ secrets.DOCKER_USERNAME }}/mi-app-flask:$TAG
          echo "Imagen taggeada: ${{ secrets.DOCKER_USERNAME }}/mi-app-flask:$TAG"

      # 8️⃣ Push Docker image a Docker Hub con fallback y sin bloquear
      - name: Push Docker image
        continue-on-error: true   # ⚡ ignorar errores aquí
        run: |
          TAG=${{ steps.tag.outputs.new_tag }}
          if [ -z "$TAG" ]; then
            TAG="v0.0.1"
          fi
          docker push ${{ secrets.DOCKER_USERNAME }}/mi-app-flask:$TAG

      # 9️⃣ Mostrar inf









