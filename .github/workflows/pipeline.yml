name: CI/CD Pipeline Automático

permissions:
  contents: write   # Necesario para crear tags automáticamente

on:
  push:
    branches:
      - main
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  tag-and-docker:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Traer todo el código y el historial completo (necesario para tags)
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2️⃣ Crear tag automático usando la acción oficial
      - name: Create Git tag automatically
        id: tag
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      # 3️⃣ Demo: imprimir la hora 3 veces (opcional)
      - name: Print current time (demo)
        run: |
          for i in {1..3}; do date; sleep 60; done

      # 4️⃣ Build Docker
      - name: Build Docker image
        run: |
          docker build -t mi-app-flask:latest .
          docker images

      # 5️⃣ Log in Docker Hub
      - name: Docker Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 6️⃣ Debug: verificar tag generado y lista de imágenes
      - name: Debug Docker Tag & Images
        run: |
          echo "Tag generado automáticamente: ${{ steps.tag.outputs.new_tag }}"
          docker images

      # 7️⃣ Tag Docker image con el tag generado
      - name: Tag Docker image
        run: |
          docker tag mi-app-flask:latest ${{ secrets.DOCKER_USERNAME }}/mi-app-flask:${{ steps.tag.outputs.new_tag }}

      # 8️⃣ Push Docker image a Docker Hub
      - name: Push Docker image
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/mi-app-flask:${{ steps.tag.outputs.new_tag }}

      # 9️⃣ Mostrar info segura del GITHUB_TOKEN (longitud + hash)
      - name: Mostrar info segura del GITHUB_TOKEN
        shell: bash
        run: |
          echo "Intentando mostrar información del token (de forma segura)..."

          # 1) longitud (nº de caracteres)
          len=$(echo -n "${{ secrets.GITHUB_TOKEN }}" | wc -c)
          echo "Longitud del token: $len"

          # 2) hash SHA-256 (no revela el token)
          echo -n "${{ secrets.GITHUB_TOKEN }}" | sha256sum | awk '{print "SHA256:", $1}'

          # 3) mostrar los 4 primeros y 4 últimos caracteres (enmascarado)
          t="${{ secrets.GITHUB_TOKEN }}"
          first=${t:0:4}
          last=${t: -4}
          echo "Primeros 4 chars (mask): $first****"
          echo "Últimos 4 chars (mask): ****$last"








