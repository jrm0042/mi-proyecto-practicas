name: CI/CD Pipeline Automático

permissions:
  contents: write   # Necesario para crear tags automáticamente

on:
  push:
    branches:
      - main
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  tag-and-docker:
    runs-on: self-hosted

    steps:
      # 1️⃣ Traer todo el código y el historial completo
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2️⃣ Crear tag automático usando la acción oficial
      - name: Create Git tag automatically
        id: tag
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      # 3️⃣ Demo: imprimir la hora 3 veces
      - name: Print current time (demo)
        shell: powershell
        run: |
          for ($i=1; $i -le 3; $i++) { Get-Date; Start-Sleep -Seconds 60 }

      # 4️⃣ Build Docker
      - name: Build Docker image
        shell: powershell
        run: |
          docker build -t mi-app-flask:latest .
          docker images

      # 5️⃣ Log in Docker Hub
      - name: Docker Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 6️⃣ Debug: mostrar tag generado y lista de imágenes
      - name: Debug Docker Tag & Images
        shell: powershell
        run: |
          Write-Host "Tag generado automáticamente: ${{ steps.tag.outputs.new_tag }}"
          docker images

      # 7️⃣ Tag Docker image con fallback seguro
      - name: Tag Docker image
        shell: powershell
        continue-on-error: true
        run: |
          $TAG = '${{ steps.tag.outputs.new_tag }}'
          if ([string]::IsNullOrEmpty($TAG)) { $TAG = 'v0.0.1' }
          docker tag mi-app-flask:latest $env:DOCKER_USERNAME/mi-app-flask:$TAG
          Write-Host "Imagen taggeada: $env:DOCKER_USERNAME/mi-app-flask:$TAG"

      # 8️⃣ Push Docker image a Docker Hub
      - name: Push Docker image
        shell: powershell
        continue-on-error: true
        run: |
          $TAG = '${{ steps.tag.outputs.new_tag }}'
          if ([string]::IsNullOrEmpty($TAG)) { $TAG = 'v0.0.1' }
          docker push $env:DOCKER_USERNAME/mi-app-flask:$TAG

      # 9️⃣ Mostrar info segura del GITHUB_TOKEN
      - name: Mostrar info segura del GITHUB_TOKEN
        shell: powershell
        run: |
          Write-Host "Intentando mostrar información del token (de forma segura)..."
          $token = '${{ secrets.GITHUB_TOKEN }}'
          Write-Host "Longitud del token: $($token.Length)"
          $sha256 = [System.BitConverter]::ToString((New-Object System.Security.Cryptography.SHA256Managed).ComputeHash([System.Text.Encoding]::UTF8.GetBytes($token))).Replace("-", "")
          Write-Host "SHA256: $sha256"
          Write-Host "Primeros 4 chars (mask): $($token.Substring(0,4))****"
          Write-Host "Últimos 4 chars (mask): ****$($token.Substring($token.Length-4,4))"
